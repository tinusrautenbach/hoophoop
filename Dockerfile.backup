FROM postgres:16

# Install required packages
RUN apt-get update && apt-get install -y \
    curl \
    unzip \
    cron \
    less \
    && rm -rf /var/lib/apt/lists/*

# Install AWS CLI v2
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" \
    && unzip awscliv2.zip \
    && ./aws/install \
    && rm -rf awscliv2.zip aws \
    && aws --version

# Set timezone to UTC
ENV TZ=UTC

# Create directories for scripts and logs
RUN mkdir -p /app/scripts /app/logs /var/log

# Copy backup and restore scripts
COPY scripts/backup-db.sh /app/scripts/
COPY scripts/restore-db.sh /app/scripts/
RUN chmod +x /app/scripts/*.sh

# Create a non-root user to run cron if needed, 
# but for simplicity in Debian/Cron we can run as root or setup specific cron user.
# The default postgres image has a 'postgres' user, but we can reuse it or create 'backupuser'.
RUN groupadd -g 1001 backupuser && \
    useradd -u 1001 -g backupuser -s /bin/bash -m backupuser

# Setup cron
# Ensure cron logs to stdout/stderr (using a wrapper or configuration)
# Debian cron typically logs to syslog. 
# We'll forward logs to the app log file.

# Create log file and set permissions
RUN touch /var/log/backup.log && \
    chown backupuser:backupuser /var/log/backup.log /app/logs

# Add crontab for backupuser
# Note: In Debian, `crontab -u user -` works.
RUN echo "0 2 * * * /app/scripts/backup-db.sh >> /var/log/backup.log 2>&1" | crontab -u backupuser -

# Switch to root to start cron (cron daemon usually requires root to start)
# The cron tasks will run as backupuser defined in crontab.
USER root

# Start cron in foreground
# -f: foreground
CMD ["cron", "-f"]
