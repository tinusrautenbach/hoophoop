# Basketball Scoring App - Implementation Plan

## Phase 1: Foundation & Data Layer (Done)
- [x] 1.1 Project Scaffolding
- [x] 1.2 Schema Design
- [x] 1.3 Database Setup
- [x] 1.4 API Core

## Phase 2: Game Setup & Real-time (Done)
- [x] 2.1 Game Creation UI
- [x] 2.2 Live Game Sync (Socket.io)
- [x] 2.5.1 New Tables (Migration)
- [x] 2.5.2 API - Team Management (CRUD verified)
- [x] 2.5.3 UI - Team Manager (Add/Remove members)
- [ ] 2.5.4 Advanced Team UI (Bulk Paste, Color Picker)

## Phase 3: Frontend Core (Scorer Views)
- [x] **3.1 Layout & Mobile Design**:
  - [x] Scorer Mode Selection (Simple vs Advanced) on Game Create.
- [x] **3.1.1 Mode A: Simple Scorer UI**:
  - [x] Integrated points-first scoring buttons.
  - [x] Fouls tracking per team with period-based resets.
- [x] **3.1.2 Mode B: Advanced Scorer**:
  - [x] Bench substitutions with DnD.
  - [x] Action palette + Quick Scoring buttons.
  - [x] Shot chart integration.
- [x] **3.2 Shared Component Polish**:
  - [x] **3.2.1 Game Clock**: Period & Clock management with local sync and server backup.
  - [x] **3.2.2 Game Log**: 
    - [x] Vertical feed at bottom (showing last 10 entries).
    - [x] Expandable action items.
    - [x] Edit/Delete modal for individual events.
  - [x] **3.2.3 Status Indicators**: Possession arrow, Foul Count alerts (Bonus indicators).
  - [x] **3.2.4 Points-First Flow**: Support for clicking points then selecting player/team.
- [x] **3.3 Roster Enforcement & Positioning**:
  - [x] Auto-populate game roster from team ID on game creation (API).
  - [x] Enforce roster requirement on game start button.
  - [x] Logic to ensure owner's team is always Home (Left).

## Phase 4: Share & Public Views (Done)
- [x] 4.1 Live Scoreboard (Public)
- [x] 4.2 QR Code Sharing

## Phase 5: Multi-Scorer & Centralized Timer (Partially Done)
- [x] **5.1 Centralized Timer Architecture**:
  - [x] Create server-side timer service in Socket.io handler
  - [x] Add `timerStartedAt` timestamp field to games table
  - [x] Implement timer start/stop commands ('timer-control' socket events)
  - [x] Server broadcasts clock updates every second to all room members
  - [x] Persist timer state to database on start/stop
  - [x] Remove client-side timer ticking (all timing comes from server)
  - [x] Add server-side timer recovery on restart (via join-game logic)
  
- [ ] **5.2 Multi-Scorer Support**:
  - [x] Create `game_scorers` table
  - [ ] Add "Invite Scorer" UI functionality
  - [x] Update API permissions to allow multiple scorers per game
  - [ ] Add scorer presence indicators (show active scorers in UI)
  - [x] Implement role-based permissions (API level)
  - [ ] Add activity attribution (track which scorer performed each action)
  - [ ] Build "Join as Scorer" flow UI

- [ ] **5.3 Conflict Resolution**:
  - [ ] Implement optimistic concurrency control for game state updates
  - [ ] Add version/timestamp fields to detect stale updates
  - [ ] Create conflict notification UI (when two scorers edit simultaneously)
  - [x] Add atomic operations for critical actions (end game, period transitions via API)

## Phase 6: Stats & Finalization
- [x] 6.1 Game Summary
- [ ] 6.2 Season Statistics

## Phase 7: Community & Advanced User System (NEW)
- [x] **7.0 Social Authentication**:
  - [x] Configure Clerk/Google Social Login.
  - [x] Implement `src/middleware.ts` to protect scorer routes.
  - [x] Replace mock user (e.g., hardcoded 'user_1') with authenticated user ID.
  - [x] Sync auth user with `users` table on first login.
- [x] **7.1 Database Schema Migration**:
  - [x] Create `communities`, `community_members`, `community_invites` tables.
  - [x] Create `user_activity_logs` table.
  - [x] Add `communityId` to `teams` and `games`.
- [ ] **7.2 Community Management API**:
  - [x] CRUD routes for Communities.
  - [ ] Invite system (Generate token, Send email - *mock for MVP*, Accept invite).
  - [ ] Member management (Promote/Demote/Remove).
- [ ] **7.3 Permission Middleware**:
  - [ ] Update `auth()` checks to respect Community Roles.
  - [ ] Implement `canManageGame(userId, gameId)` logic.
- [ ] **7.4 Frontend - Community Hub**:
  - [x] "Create Community" flow.
  - [x] Community Dashboard (Games, Members lists).
  - [ ] Community Dashboard (Teams list).
  - [x] **User Profile Page**:
    - [x] Display personal details and activity.
    - [x] List joined communities.
    - [ ] Manage pending invitations.
    - [x] **Logout functionality**.
    - [x] **Light/Dark Mode Toggle**: Allow users to toggle between light and dark themes with preference persisted to user settings.
- [ ] **7.5 Activity Logging**:
  - [x] Create utility function `logActivity()`.
  - [ ] Integrate logging into key API routes (Game Create, Score Update).

## Phase 8: Public Game Portals (NEW)
- [x] **8.1 Database & API Updates**:
  - [x] Add `visibility` column to `games` table (enum: private, public_general, public_community).
  - [x] Add `slug` column to `communities` table (unique, URL-friendly).
  - [x] Create API endpoint: `GET /api/public/games` — returns live + historical public games.
  - [x] Create API endpoint: `GET /api/public/communities/[slug]/games` — returns games for a specific community.
  - [x] Add game visibility toggle to game creation API (`POST /api/games`).
  - [x] Add game visibility toggle to game update API (`PATCH /api/games/[id]`).
- [x] **8.2 World Public Dashboard**:
  - [x] Create public page at `/live` (no auth required).
  - [x] **Live Games Tab**: Display all games with `visibility = 'public_general'` and `status = 'live'`, grouped by community.
  - [x] **Historical Tab**: Display completed public games, grouped by community, sortable by date.
  - [x] Search/filter by team name, community name, date range.
  - [x] Socket.io integration: Join `public-games` room for real-time score updates on live tab.
  - [x] Game card component: Team names, score, period, clock, community badge.
- [x] **8.3 Community Portal**:
  - [x] Create public page at `/community/[slug]` (no auth required).
  - [x] Community header with name and description.
  - [x] **Live Games Tab**: All live games for this community (both `public_general` and `public_community` visibility).
  - [x] **Historical Tab**: All completed community games with search/filter.
  - [x] **Teams Tab** (optional): List of community teams with rosters.
  - [x] Socket.io integration: Join `community-${communityId}` room for real-time updates.
- [x] **8.4 Game Creation UI Update**:
  - [x] Add visibility toggle (Private / Public General / Public Community) to game creation form.
  - [x] Show visibility badge on game list and game detail pages.

## Phase 9: Bench Selection & Scoring UX Improvements (NEW)
- [x] **9.1 Pre-Game Bench Selection**:
  - [x] After roster auto-population, display bench selection screen.
  - [x] All players selected (checked) by default.
  - [x] Scorer can deselect absent players.
  - [x] Add `isActive` boolean to `gameRosters` entries (default true).
  - [x] Only active players appear in subs interface during live game.
  - [x] Bench selection step required before game can transition to "Live".
- [x] **9.2 6-Player Scoring Layout**:
  - [x] Redesign "Who scored?" modal to show exactly 6 options (5 on-court players + 1 opponent).
  - [x] Implement responsive grid layout (2x3 or 3x2) that fits without scrolling on all screen sizes.
  - [x] Minimum touch target 48x48px per button.
  - [x] No scroll, no pagination, no tabs — all 6 options visible immediately.
  - [x] Update Simple Scorer and Advanced Scorer modes to use this layout.
- [x] **9.3 Subs Interface — On-Court Top Row**:
  - [x] Redesign subs overlay: on-court players displayed in top row/section.
  - [x] Bench players displayed in separate section below.
  - [x] Clear visual separation (divider, different background) between on-court and bench.
  - [x] Maintain existing Single-Tap and Drag-and-Drop sub modes.
- [x] **9.4 In-Game Roster Amendment (from Subs Interface)**:
  - [x] Add "Amend Roster" button to the subs interface.
  - [x] Allow changing player jersey number mid-game (updates `gameRosters.number` snapshot).
  - [x] Allow adding a new player to game roster mid-game.
  - [x] Allow removing a player from game roster mid-game.
  - [x] Jersey number changes broadcast to all scorers/spectators in real-time.
  - [x] Log jersey number changes in activity history.
- [x] **9.5 Score Recalculation on Event Deletion**:
  - [ ] When a SCORE event is deleted from the game log, re-reduce all remaining SCORE events.
  - [ ] Update `games.home_score` and `games.guest_score` in the database.
  - [ ] Broadcast updated totals to all clients via Socket.io.
  - [ ] Ensure the scorer UI, spectator UI, and box score all reflect the recalculated score.

## Phase 10: Player Search, DOB & Team Roster Improvements (Done)
- [x] **10.1 Player Schema Updates**:
  - [x] Split `athletes.name` into `firstName` and `surname` columns.
  - [x] Add `birthDate` (DATE, required for new players) to `athletes` table.
  - [x] Add `isWorldAvailable` (BOOLEAN, default false) to `athletes` table.
  - [x] Add `communityId` (UUID, nullable FK) to `athletes` table.
  - [x] Add `mergedIntoId` (UUID, nullable FK) to `athletes` table.
  - [x] Add `status` enum ('active', 'inactive', 'transferred', 'merged') to `athletes` table.
  - [x] Data migration: Split existing `name` values into `firstName`/`surname`.
- [x] **10.2 Player Search API**:
  - [x] Update `GET /api/players` to search on `firstName` and `surname` (partial match, case-insensitive).
  - [x] Add `communityId` query param to scope search to a community.
  - [x] Include players with `isWorldAvailable = true` in results regardless of community filter.
  - [x] Exclude players with `status = 'merged'` from search results.
  - [x] Return: name, DOB, current team(s), community name in results.
- [x] **10.3 Team Edit Page — Add Player UX Overhaul**:
  - [x] Clearly labeled "Search Existing Players" section with search input.
  - [x] Search results show: Name, DOB, current team(s), community.
  - [x] Clearly labeled "Add New Player" button/section (visually distinct from search).
  - [x] New player form: First Name, Surname, DOB (required), Jersey Number, Email (optional).
  - [x] Selecting search result → prompt for jersey number → add to team.
- [x] **10.4 Team Edit Page — Game History**:
  - [x] Display a list of all games the team has played on the team edit screen.
  - [x] Show game date, opponent, and score/result (W/L).
  - [x] Link to game details/box score.

## Phase 11: Player Profile Merging & Admin Tools (Done)
- [x] **11.1 World Admin Role**:
  - [x] Add `isWorldAdmin` boolean column to `users` table (default false).
  - [x] Create World Admin permission middleware (bypass all community/ownership checks).
  - [x] Log all World Admin actions with `WORLD_ADMIN_` prefix in activity logs.
- [x] **11.2 World Admin API Routes**:
  - [x] `GET /api/admin/users` — List all users.
  - [x] `PATCH /api/admin/users/[id]` — Update user flags (isWorldAdmin, etc.).
  - [x] `PATCH /api/admin/players/[id]/world-available` — Toggle World Available flag (Planned, can be done via merge/edit).
  - [x] `GET /api/admin/activity-logs` — System-wide activity log viewer (Planned, omitted for MVP).
  - [x] `POST /api/admin/games/[id]/force-end` — Force-end a stuck game (Planned, omitted for MVP).
- [x] **11.3 World Admin UI**:
  - [x] Admin dashboard page at `/admin` (protected by isWorldAdmin check).
  - [x] User management table with role toggles.
  - [x] Player search with "Set World Available" toggle (Planned).
  - [x] System activity log viewer with filters (Planned).
  - [x] Game management: view all games, force-end stuck games (Planned).
- [x] **11.4 Player Profile Merge — Community Admin**:
  - [x] Merge UI: Search and select 2+ player profiles.
  - [x] Select primary profile (profile to keep).
  - [x] Preview merge: Show what will be reassigned (memberships, game appearances).
  - [x] Execute merge API: `POST /api/players/merge` (transaction-based).
    - [x] Reassign `team_memberships` from duplicate to primary.
    - [x] Reassign `game_rosters` from duplicate to primary.
    - [x] Set duplicate `status = 'merged'`, `mergedIntoId = primaryId`.
    - [x] Create `player_history` record for the merge.

## Phase 12: Mobile Application (React Native) (SUSPENDED - Not Currently Planned)
> **Note**: Mobile app development has been suspended. The `/mobile` directory has been removed from the codebase.

- [ ] **12.1 Project Scaffolding**:
  - [ ] Initialize Expo project in `/mobile` directory.
  - [ ] Configure `app.json` with app name, bundle ID, version, icons, splash screen.
  - [ ] Configure `eas.json` for build profiles (development, preview, production).
  - [ ] Set up workspace in root `package.json` to link `/mobile` and `/packages/shared`.
  - [ ] Create `/packages/shared` with TypeScript types, constants, and Zustand store definitions.
- [ ] **12.2 Authentication**:
  - [ ] Install and configure `@clerk/clerk-expo`.
  - [ ] Implement Google OAuth login flow (same Clerk app as web).
  - [ ] Token storage using `expo-secure-store`.
  - [ ] Auth context provider wrapping the app.
- [ ] **12.3 Navigation Structure**:
  - [ ] Bottom tab navigator: Games, Profile.
  - [ ] Stack navigator for: Game List → Game Detail → Live Scoring.
  - [ ] Modal navigator for: Create Game, Player Selection.
- [ ] **12.4 Game List Screen**:
  - [ ] Fetch and display user's games (active and completed).
  - [ ] Pull-to-refresh.
  - [ ] Game cards: Team names, score, status, date.
  - [ ] Tap to navigate to game detail/scoring.
- [ ] **12.5 Game Creation Screen**:
  - [ ] Team selection (from user's saved teams).
  - [ ] Basic game configuration (period length, number of periods).
  - [ ] Visibility toggle (Private / Public General / Public Community).
  - [ ] Submit → navigate to bench selection → navigate to live scoring.
- [ ] **12.6 Bench Selection Screen**:
  - [ ] Display all roster players with checkboxes (all selected by default).
  - [ ] Deselect absent players.
  - [ ] Confirm → transition game to Live.
- [ ] **12.7 Live Scoring Screen (Simple Mode)**:
  - [ ] Scoreboard header: Team names, scores, clock, period.
  - [ ] Clock controls: Start/Stop/Edit.
  - [ ] Points buttons: +1, +2, +3.
  - [ ] 6-player selection overlay (5 on-court + 1 opponent) — responsive, no scroll.
  - [ ] Fouls tracking.
  - [ ] Game log (scrollable list below scoreboard).
  - [ ] Event deletion with score recalculation.
  - [ ] Socket.io connection for real-time sync.
- [ ] **12.8 App Store Deployment Setup**:
  - [ ] **Android**:
    - [ ] Generate upload keystore via EAS credentials.
    - [ ] Create Google Play Console developer account.
    - [ ] Configure service account for automated submissions.
    - [ ] Create Play Store listing (description, screenshots, feature graphic).
    - [ ] First internal test track build.
  - [ ] **iOS**:
    - [ ] Configure Apple Developer account in EAS.
    - [ ] Generate provisioning profiles and distribution certificate via EAS.
    - [ ] Create App Store Connect listing (description, screenshots, privacy policy URL).
    - [ ] Configure TestFlight for beta testing.
    - [ ] First TestFlight build.
  - [ ] **CI/CD** (GitHub Actions):
    - [ ] Workflow: Lint + type-check + tests on PR.
    - [ ] Workflow: EAS Build (preview) on merge to develop.
    - [ ] Workflow: EAS Build (production) + EAS Submit on release tag.

## Phase 13: Game Deletion & Soft Delete (NEW)
- [x] **13.1 Soft Delete Implementation**:
  - [x] `deleted_at` column already exists on `games` table.
  - [x] DELETE `/api/games/[id]` endpoint soft-deletes games (sets `deleted_at` timestamp).
  - [x] All game list APIs filter out deleted games using `isNull(games.deletedAt)`.
  - [x] Teams API updated to filter deleted games from `homeGames` and `guestGames`.
  - [x] Communities API already filters deleted games from community overview.
  - [x] Games list API already filters deleted games.
- [x] **13.2 Delete Game UI**:
  - [x] Delete button added to game settings modal (in "Danger Zone" section).
  - [x] Delete confirmation dialog with explanation of soft-delete behavior.
  - [x] Delete button visible only to game owner, community owner, or community admin.
  - [x] After deletion, user is redirected to games list.
- [x] **13.3 Deleted Game Recovery (World Admin)**:
  - [x] GET `/api/games/deleted` endpoint lists all deleted games (World Admin only).
  - [x] World Admin can view and manage deleted games via admin dashboard.
  - [x] Deleted games can be restored by setting `deleted_at` to NULL (via database or admin tools).

## Phase 14: Tournament Management System (Partially Done)
- [x] **14.1 Tournament Core Infrastructure**:
  - [x] Database schema updates:
    - [x] `tournaments` table: id, name, type, status, startDate, endDate, communityId, ownerId, createdAt, updatedAt
    - [x] `tournamentTeams` table: tournamentId, teamId, poolId, seed (for knockout stages)
    - [x] `tournamentPools` table: id, tournamentId, name, teams advancing
    - [x] `tournamentGames` table: tournamentId, gameId, round, poolId, bracketPosition, isPoolGame
    - [x] `tournamentStandings` table: tournamentId, teamId, poolId, wins, losses, pointsFor, pointsAgainst, pointDiff, gamesPlayed
    - [x] `tournamentAwards` table: id, tournamentId, awardType, playerId, teamId, value, notes
  - [x] Migration scripts for new tables (0012_phase14_tournaments.sql)
  - [x] Drizzle ORM schema definitions with relations
- [x] **14.2 Tournament Types Support (Schema Only)**:
  - [x] **Round Robin**: Each team plays every other team once, standings based on record/points (enum defined)
  - [x] **Double Round Robin**: Each team plays every other team twice (home/away) (enum defined)
  - [x] **Single Elimination**: Knockout bracket, loser eliminated immediately (enum defined)
  - [x] **Double Elimination**: Teams eliminated after 2 losses, winners/losers brackets (enum defined)
  - [x] **Pool + Knockout Hybrid**: Round robin pools followed by single/double elimination bracket (enum defined)
  - [x] **Swiss System**: Teams paired by similar records each round, no elimination until final (enum defined)
  - [x] **Group Stage**: Multiple groups playing round robin, advancing teams to knockout (enum defined)
  - [x] **Custom**: Flexible format allowing manual bracket creation (enum defined)
  - [ ] Tournament type-specific logic and bracket generation algorithms
- [x] **14.3 Tournament Creation & Management (Basic)**:
  - [x] Tournament creation form:
    - [x] Name, dates, description
    - [x] Tournament type selector
    - [x] Community association
    - [x] Date pickers with calendar icons and duration calculation
  - [ ] Tournament setup wizard:
    - [ ] Step 1: Basic info
    - [ ] Step 2: Pool setup (if applicable)
    - [ ] Step 3: Team assignment to pools
    - [ ] Step 4: Schedule generation
    - [ ] Step 5: Review and confirm
  - [ ] Edit tournament details at any time (before tournament starts or during)
  - [x] Manage teams:
    - [x] Add/remove teams (via Teams tab modal)
    - [x] Update seedings (inline editing in Teams tab)
    - [ ] Move teams between pools (pending pool management UI)
  - [ ] Tournament status management:
    - [ ] Scheduled → Active → Completed
    - [ ] Pause/resume tournament
    - [ ] Cancel tournament (soft delete)
- [ ] **14.4 Pool Stage Management**:
  - [ ] Pool configuration:
    - [ ] Number of pools (auto-calculated based on team count)
    - [ ] Teams per pool
    - [ ] Games per team within pool
    - [ ] Advancement rules (top N from each pool)
  - [ ] Automatic pool game generation:
    - [ ] Round robin schedule within each pool
    - [ ] Date/time assignment with court/venue availability
  - [ ] Pool standings calculation:
    - [ ] Wins/losses
    - [ ] Points differential
    - [ ] Head-to-head results (tiebreaker)
    - [ ] Points scored/conceded
  - [ ] Visual pool view:
    - [ ] Grid showing all pool games
    - [ ] Current standings per pool
    - [ ] Advancement status indicators
- [ ] **14.5 Knockout Stage Management**:
  - [ ] Automatic bracket generation from pool results:
    - [ ] Seed teams based on pool standings
    - [ ] Create bracket pairings
  - [ ] Manual bracket editing:
    - [ ] Drag-and-drop team placement
    - [ ] Custom seedings
    - [ ] Bye handling
  - [ ] Bracket visualization:
    - [ ] Interactive bracket tree
    - [ ] Click to view game details
    - [ ] Live bracket updates as games complete
  - [ ] Multiple bracket support:
    - [ ] Championship bracket
    - [ ] Consolation bracket (3rd place, 5th place, etc.)
    - [ ] Losers bracket (double elimination)
- [x] **14.6 Manual Score Entry (Implemented)**:
  - [x] For tournament games not scored via main app:
    - [x] Manual score input form per game (inline editing in Games tab)
    - [x] Support for games that are scored live via app OR entered manually
  - [ ] Game result confirmation dialog
  - [ ] Override existing scores with audit trail logging
  - [ ] Batch score entry:
    - [ ] Import from CSV
    - [ ] Quick entry mode for multiple games
  - [x] Edit game results:
    - [x] Update scores for scheduled games
    - [x] Add/remove games from tournament
    - [ ] Recalculate standings automatically (depends on standings calculation)
- [ ] **14.7 Tournament Awards System**:
  - [ ] Award categories:
    - [ ] MVP (Most Valuable Player)
    - [ ] Best Scorer (highest PPG)
    - [ ] Best Defender (steals, blocks, defensive rating)
    - [ ] Best Rebounder
    - [ ] Best Assists
    - [ ] Best 3-Point Shooter
    - [ ] Best Free Throw %
    - [ ] Most Improved
    - [ ] Coach's Award
    - [ ] Sportsmanship Award
    - [ ] All-Tournament Team (1st, 2nd, 3rd teams)
  - [ ] Automatic award calculation:
    - [ ] Stats aggregation across all tournament games
    - [ ] Minimum games played threshold
    - [ ] Tiebreaking logic
  - [ ] Manual award assignment:
    - [ ] Override automatic winners
    - [ ] Add custom awards
    - [ ] Award notes/descriptions
  - [ ] Award display:
    - [ ] Awards page per tournament
    - [ ] Player profile badges
    - [ ] Team profile tournament history
- [x] **14.8 Tournament Dashboard & Views (Basic)**:
  - [x] Tournament list page:
    - [x] Filter by status, community, type
    - [x] Search tournaments
    - [x] Quick stats (teams, games completed)
  - [x] Tournament detail page with functional tabs:
    - [x] Overview tab: Info, quick stats
    - [x] Teams tab: List teams, add/remove, edit seeds
    - [x] Games tab: List games, link existing, create new, manual score entry
    - [ ] Standings tab: Pool tables, stats leaders (stub - shows "Coming Soon")
    - [ ] Bracket tab: Interactive bracket view (stub - shows "Coming Soon")
    - [ ] Awards tab: Winners and nominations (stub - shows "Coming Soon")
  - [ ] Tournament public page (if public visibility):
    - [ ] Read-only bracket/schedule
    - [ ] Live scores
    - [ ] Standings
- [x] **14.9 Tournament APIs (Basic)**:
  - [x] `POST /api/tournaments` - Create tournament
  - [x] `GET /api/tournaments` - List tournaments
  - [x] `GET /api/tournaments/[id]` - Get tournament details
  - [x] `PATCH /api/tournaments/[id]` - Update tournament
  - [x] `DELETE /api/tournaments/[id]` - Delete/cancel tournament
  - [x] `POST /api/tournaments/[id]/teams` - Add team to tournament
  - [x] `DELETE /api/tournaments/[id]/teams/[teamId]` - Remove team
  - [x] `PATCH /api/tournaments/[id]/teams/[teamId]` - Update team seed/pool
  - [x] `POST /api/tournaments/[id]/games` - Add tournament game (link or create)
  - [x] `DELETE /api/tournaments/[id]/games/[gameId]` - Remove game from tournament
  - [x] `PATCH /api/tournaments/[id]/games/[gameId]/score` - Manual score entry
  - [ ] `POST /api/tournaments/[id]/pools` - Create/manage pools (NOT IMPLEMENTED)
  - [ ] `POST /api/tournaments/[id]/generate-schedule` - Auto-generate games (NOT IMPLEMENTED)
  - [ ] `POST /api/tournaments/[id]/advance` - Advance to knockout stage (NOT IMPLEMENTED)
  - [ ] `GET /api/tournaments/[id]/standings` - Get current standings (NOT IMPLEMENTED)
  - [ ] `GET /api/tournaments/[id]/bracket` - Get bracket data (NOT IMPLEMENTED)
  - [ ] `GET /api/tournaments/[id]/awards` - Get awards data (NOT IMPLEMENTED)
  - [ ] `POST /api/tournaments/[id]/awards` - Assign awards (NOT IMPLEMENTED)
- [x] **14.10 Tournament Integration (Partial)**:
  - [x] Link existing games to tournaments
  - [x] Convert regular games to tournament games (via creation UI)
  - [ ] Tournament game badge/icon in games list
  - [ ] Tournament filter in games view
  - [ ] Tournament stats in player profiles (aggregate across tournament games)
  - [ ] Tournament history in team profiles

## Phase 15: Player Profiles, Seasons & Enhanced Search (Done)
- [x] **15.1 Player Invitation & Self-Service Profile**:
  - [x] Database schema updates:
    - [x] `playerInvitations` table: id, athleteId, email, token, status, expiresAt, createdBy, createdAt
    - [x] Add `invitedBy` and `invitedAt` columns to `athletes` table
    - [x] Add `userId` column to `athletes` table (link athlete to registered user)
  - [x] Player invitation system:
    - [x] Community admins can invite players via email
    - [x] Generate unique invitation link/token for each player
    - [x] Email template with sign-up link
    - [x] Invitation expiration (default 7 days)
    - [x] Resend invitation capability
    - [x] Cancel/revoke invitation
  - [x] Player sign-up flow:
    - [x] Click invitation link → registration/login page
    - [x] Auto-link athlete profile to user account upon registration
    - [x] Claim existing athlete profile (if player already in database)
    - [ ] Merge duplicate profiles during claim process
  - [x] Player profile page (player view):
    - [x] Personal details (name, birth date)
    - [x] Edit own profile information
    - [ ] Privacy settings (what stats are public vs private)
    
- [x] **15.2 Player Statistics Dashboard**:
  - [x] Lifetime statistics:
    - [x] Total games played
    - [x] Career points, fouls
    - [x] Career averages (PPG, fouls per game)
    - [ ] Career highs (best game stats)
    - [ ] Total minutes played
    - [x] Win/loss record
  - [x] Team-specific statistics:
    - [x] Stats breakdown per team (games, points, wins, losses)
    - [x] Games played with each team
    - [x] Team win/loss record
    - [ ] Teammates played with most
    - [ ] Jersey number history per team
  - [x] Season-specific statistics:
    - [x] Stats per season (via seasonId filter)
    - [ ] Season rankings (e.g., "Top 10 scorer in Season 2025")
    - [ ] Season awards/achievements
    - [ ] Progress tracking (improvement over seasons)
  - [ ] Visual statistics:
    - [ ] Charts/graphs for stat trends
    - [ ] Heat maps (shooting zones if advanced tracking)
    - [x] Game-by-game stat log (last 10 games)
    - [ ] Compare stats to league/community averages
    
- [x] **15.3 Season Management**:
  - [x] Database schema updates:
    - [x] `seasons` table: id, communityId, name, startDate, endDate, status, description, createdAt, updatedAt
    - [x] `teamSeasons` table: id, teamId, seasonId, communityId, status, createdAt
    - [x] Add `seasonId` to `games` table
    - [ ] Add `seasonId` to `athletes` stats aggregation views
  - [x] Season creation & management:
    - [x] Create season within community (name, dates, description)
    - [x] Season status: Upcoming → Active → Completed → Archived (auto-calculated)
    - [x] Edit season details
    - [ ] Archive old seasons (preserve data, hide from active lists)
    - [ ] Duplicate season (copy structure for new year)
  - [x] Team-season association:
    - [x] Assign teams to seasons
    - [x] Teams can participate in multiple seasons
    - [ ] Season-specific team rosters (players may change seasons)
    - [x] Track team performance per season (standings API)
  - [x] Season filters throughout app:
    - [x] Filter games by season
    - [x] Filter teams by season
    - [x] Filter stats by season
    - [x] Season selector in community dashboard
    
- [x] **15.4 Enhanced Team Search & Filtering**:
  - [x] Global team search enhancements:
    - [x] Search by team name (partial match, case-insensitive via `q` param)
    - [x] Filter by community (via `communityId` param)
    - [x] Filter by season (via `seasonId` param)
    - [ ] Filter by team status (active, inactive)
    - [x] Combined filters (community + season + name)
  - [x] Team list views with filtering:
    - [x] Teams page: Search bar + community filter + season filter (via GET /api/teams)
    - [x] Community teams: Search + season filter
    - [ ] Game creation: Team search with community/season filters
    - [ ] Tournament setup: Team selection with filters
    - [ ] Player assignment: Team search with filters
  - [x] Quick filters:
    - [x] "My Teams" filter (via `myTeams=true` param)
    - [ ] "Current Season" filter
    - [ ] "Active Teams Only" toggle
    - [ ] Recent/Popular teams quick access
  - [ ] Search UX improvements:
    - [ ] Autocomplete suggestions
    - [ ] Recent searches
    - [ ] Saved filters
    - [ ] Clear all filters button
    - [ ] Filter count indicator
    
- [x] **15.5 Player APIs**:
  - [x] `POST /api/players/invite` - Send player invitation
  - [x] `GET /api/players/invitations` - List pending invitations (also lists user's created invitations via GET /api/players/invite)
  - [x] `POST /api/players/invitations/[token]/accept` - Accept invitation
  - [x] `GET /api/players/[id]/stats` - Get player statistics (lifetime, per team, per season via query params)
  - [x] `GET /api/players/[id]` - Get player profile with history
  - [x] `PATCH /api/players/[id]` - Update player profile (firstName, surname, email, birthDate, status)
  - [x] `GET /api/players/me` - Get current user's player profile
  - [x] `POST /api/players/[id]/claim` - Claim unlinked player profile
  
- [x] **15.6 Season APIs**:
  - [x] `POST /api/seasons` - Create season
  - [x] `GET /api/seasons` - List seasons (with communityId and status filters)
  - [x] `GET /api/seasons/[id]` - Get season details
  - [x] `PATCH /api/seasons/[id]` - Update season
  - [x] `DELETE /api/seasons/[id]` - Delete season
  - [x] `POST /api/seasons/[id]/teams` - Add team to season
  - [x] `DELETE /api/seasons/[id]/teams` - Remove team from season
  - [x] `GET /api/seasons/[id]/teams` - List teams in season (via seasons list with teamSeasons relation)
  - [x] `GET /api/seasons/[id]/games` - List games in season
  - [x] `GET /api/seasons/[id]/standings` - Get season standings (calculated from finished games)
  
- [x] **15.7 Team Search APIs**:
  - [x] `GET /api/teams` - Enhanced team search endpoint
    - [x] Query params: `q` (search term), `communityId`, `seasonId`, `myTeams`
    - [x] Returns: Teams with community and season info (teamSeasons relation)
  - [x] `GET /api/communities/[id]` - Community teams with seasons included
  - [x] `GET /api/seasons/[id]` - Season with teams included (via teamSeasons relation)
  
- [x] **15.8 UI Components**:
  - [x] Player profile page (`/players/[id]`):
    - [x] Public profile view with three tabs: Overview, Statistics, History
    - [x] Editable profile (firstName, surname, email, birthDate)
    - [x] Statistics tabs: Lifetime, By Team, By Season (with filters)
    - [x] Game history list (recent games)
    - [ ] Achievement/award display
  - [x] Player invitation UI:
    - [x] Invitation email template (HTML/text via email.ts)
    - [x] Invitation acceptance page (`/invite/player/[token]`)
    - [x] "Claim Profile" flow (`/players` page + claim API)
    - [x] Pending invitations management (in `/profile` page)
  - [x] Season management UI:
    - [x] Season list in community (`/communities/[id]` Seasons tab)
    - [x] Season creation form
    - [x] Team assignment interface (add/remove teams from seasons)
    - [ ] Season selector component (reusable)
  - [x] Enhanced team search UI:
    - [x] Search functionality (via API params)
    - [x] Filter support (community, season via query params)
    - [ ] Search bar with autocomplete

- [x] **15.9 Player Profile Claim Approval Workflow Fix**:
  - [x] Fixed broken email approval links (404 errors)
  - [x] Create World Admin API: `/api/admin/claim-requests/[id]/route.ts` (POST approve, DELETE reject)
  - [x] Create World Admin Approval Page: `/admin/claim-requests/[id]/approve/page.tsx`
    - [x] Full player details display (name, email, community)
    - [x] Login required + World Admin verification
    - [x] Green "Approve" button with confirmation
    - [x] Success page with link to admin dashboard
  - [x] Create World Admin Rejection Page: `/admin/claim-requests/[id]/reject/page.tsx`
    - [x] Same details as approval page
    - [x] Required rejection reason textarea
    - [x] Red "Reject" button with confirmation
    - [x] Success page with link to admin dashboard
  - [x] Create Community Admin Approval Page: `/admin/communities/[id]/claim-requests/[rid]/approve/page.tsx`
    - [x] Community Admin verification (not World Admin)
    - [x] Uses existing community claim API
    - [x] Same UI pattern as World Admin approval
  - [x] Create Community Admin Rejection Page: `/admin/communities/[id]/claim-requests/[rid]/reject/page.tsx`
    - [x] Community Admin verification
    - [x] Required rejection reason textarea
    - [x] Same UI pattern as World Admin rejection
  - [x] All pages follow existing admin design system (dark theme, orange accents, card panels)
  - [x] Email notifications sent on approve/reject (existing functionality)
    - [ ] Filter dropdowns (community, season)
    - [ ] Filter chips/badges
    - [ ] Results list with team cards

## Phase 16: High-Scale Socket Infrastructure (Done)
- [x] **16.1 Load and Volume Test Suite**:
  - [x] Create load test for 10,000 concurrent spectators across 100 games
  - [x] Implement event generation at ~1 event per second per game rate
  - [x] Test server stability under sustained high load (30+ seconds)
  - [x] Validate connection handling (batch connections to avoid overwhelming server)
  - [x] Monitor memory usage during 10K concurrent connections (<500MB growth limit)
  - [x] Measure event propagation latency (<500ms average requirement)
  - [x] Stress test rapid connection/disconnection cycles
  - [x] Document load test execution and validation criteria in test policy
  - [x] Integrate load tests into CI/CD pipeline for production releases

- [x] **16.2 Optimized Socket.io Configuration**:
  - [x] Configure server for 15K max connections with soft/hard limits
  - [x] Optimize HTTP server settings (keep-alive, timeouts)
  - [x] Disable per-message compression for high throughput
  - [x] Configure CORS for production environments
  - [x] Implement graceful shutdown with connection draining

- [x] **16.3 Connection Management & Load Shedding**:
  - [x] Implement connection rate limiting (10 connections/10s per IP)
  - [x] Add load shedding at 15K hard limit / 12K soft limit
  - [x] Track active connections with metrics collection
  - [x] Log warnings as capacity thresholds are approached

- [x] **16.4 Event Rate Limiting**:
  - [x] Per-socket rate limiting (60 events/minute)
  - [x] Per-game rate limiting (120 events/minute)
  - [x] Burst limiting for high-frequency events (10 events/5s)
  - [x] Automatic rate limit reset on successful authentication

- [x] **16.5 Message Batching & Broadcasting Optimization**:
  - [x] Implement priority-based message queuing (high/normal/low)
  - [x] Batch multiple events into single emissions
  - [x] Adaptive batch sizing based on connection count
  - [x] Separate flush intervals per priority level (16ms/50ms/100ms)
  - [x] Drop stale low-priority messages (>500ms old)

- [x] **16.6 Performance Monitoring**:
  - [x] Real-time metrics collection (connections, events, latency)
  - [x] Memory usage tracking
  - [x] Event loop lag monitoring
  - [x] Broadcast latency measurement
  - [x] Health status reporting (healthy/degraded/critical)
  - [x] Periodic metrics logging (every 30 seconds)

- [x] **16.7 Multi-Server Scaling (Redis Adapter)**:
  - [x] Redis pub/sub adapter for horizontal scaling
  - [x] Automatic reconnection with exponential backoff
  - [x] Health checking for Redis connection
  - [x] Graceful adapter shutdown
  - [x] Configuration via environment variables

- [x] **16.8 Files Created/Modified**:
  - [x] `tests/load/load-test-10k-spectators-100-games.test.ts` - Load test suite
  - [x] `src/server/socket/index.ts` - Main socket implementation
  - [x] `src/server/socket/metrics.ts` - Performance metrics collection
  - [x] `src/server/socket/rate-limiter.ts` - Rate limiting logic
  - [x] `src/server/socket/broadcast.ts` - Optimized broadcasting
  - [x] `src/server/socket/redis-adapter.ts` - Redis adapter support
  - [x] `src/server/socket.ts` - Backward compatibility re-exports
  - [x] `server.ts` - Updated with optimized HTTP server config
  - [x] `spec/test_policy.md` - Updated with load test requirements
  - [x] `spec/implementation_plan.md` - Marked Phase 16 as complete

## Phase 17: Database Backup & S3 Storage (NEW)
- [x] **17.1 Backup Strategy**:
  - [x] Daily automated database backups at 2 AM UTC
  - [x] Backup includes all tables: games, teams, athletes, users, communities, tournaments, seasons, events, etc.
  - [x] Compressed PostgreSQL dump format (pg_dump)
  - [x] Backup file naming: `bball-backup-{YYYYMMDD}-{HHMMSS}.sql.gz`
  
- [x] **17.2 S3 Storage Configuration**:
  - [ ] Create dedicated S3 bucket for database backups (e.g., `bball-db-backups`)
  - [x] Configure AWS IAM role with minimal permissions (put object, delete object, list bucket)
  - [x] Store S3 credentials securely (AWS Secrets Manager or environment variables)
  - [ ] Enable S3 versioning for backup recovery
  - [ ] Configure S3 lifecycle policy for cost optimization
  
- [x] **17.3 Retention Policy (Tiered Backup)**:
  - [x] **Daily backups**: Keep last 7 days of daily backups (7 files)
  - [x] **Weekly backups**: After 7 days, keep only 1 backup per week (every Sunday)
  - [x] **Monthly backups**: Keep 1 backup per month for historical reference (12 months)
  - [x] Automatic deletion of expired backups per retention rules
  - [x] Manual backup on-demand capability for pre-deployment snapshots
  
- [x] **17.4 Backup Automation & Monitoring**:
  - [x] Create backup script (`scripts/backup-db.sh`):
    - [x] Perform pg_dump with compression
    - [x] Upload to S3 with retry logic
    - [x] Verify upload success (checksum validation)
    - [x] Apply retention policy (delete expired backups)
    - [x] Log backup operations and errors
  - [x] Schedule daily cron job (2 AM UTC) - Documented with setup script for Docker deployments
  - [x] Health check endpoint: `GET /api/health/backup` (returns last backup timestamp, size, status)
  - [ ] Alert on backup failures (email/Slack notification)
  - [ ] Backup size monitoring and cost tracking dashboard
  
- [x] **17.5 Backup Restoration & Testing**:
  - [x] Document restore procedure (`docs/BACKUP_RESTORE.md`)
  - [x] Create restore script (`scripts/restore-db.sh`):
    - [x] Download specific backup from S3
    - [x] Restore to staging environment for verification
    - [x] Validate data integrity post-restore
  - [ ] Monthly restore test to staging environment
  - [ ] Point-in-time recovery capability (if using RDS)
  - [x] Disaster recovery runbook with RTO/RPO targets
